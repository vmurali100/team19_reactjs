<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>


    <script>

        //create

        function readusersfromForm(){

             var user={
                fname:document.getElementById('fname').value,
                email:document.getElementById('email').value,
                gender:document.getElementById('gender').value,
                state:document.getElementById('state').value,
                subjects:[]

             }
              var allsubjects=document.getElementsByName('subjects');
              for(let index=0;index<allsubjects.length;index++){
                if(allsubjects[index].checked){
                    user.subjects.push(allsubjects[index].value)
                }
              }
              return user
            }

            function createuser(){
                var user=readusersfromForm()
                //posting data to server
                //1.Using XMLHttpRequest
                // If a function returning a promise ,we should use .then for success, .catch  for error

                fetch("http://localhost:3000/users",{
                    method:"POST",
                    body:JSON.stringify(user),
                    headers:{"content-type":"application/json"},
                }).then(()=>{
                    getusersfromAPI()
                })
            }

            //edit

            
    var usertoedit=JSON.parse(localStorage.getItem("usertoedit"))

    console.log("in edit user page",usertoedit)

    for(a in  usertoedit){
        if(a!=="subjects"){
            document.getElementById(a).value=usertoedit[a]
        }else if(a =="subjects"){
            //let subjects=usertoedit["subjects"];

            let subjects=usertoedit.subjects;
             
            var allcheckboxes=document.getElementsByName("subjects");
            for(let index=0;index<allcheckboxes.length;index++){
                const element=allcheckboxes[index];
                var check=subjects.some((sub)=>element.value ===sub);
                element.checked=check
            }
        }
    }

    function updateuser(){
        var user=readusersfromForm()
        console.log(user)
        fetch("http://localhost:3000/users" +usertoedit.id,{
            method:"PUT",
            body:JSON,stringify(user),
            headers:{"content-type": "application/json"},
        }).then(()=>{
            console.log("user updated !!!")
            window.location.href="sample1_intro.html"
        })
    }


//read


    var users = [];
function getUsersFromAPI() {
  fetch("http://localhost:3000/users")
    .then((response) => {
      console.log(response);
      return response.json();
    })
    .then((data) => {
      users = data;
      console.log(data);
      displayUsers()
    });
}

function displayUsers() {
    for (let index = 0; index < users.length; index++) {
        var eachObj = users[index]
       var myTr = document.createElement("tr");
       for(a in eachObj){
        var myTd = document.createElement("td");
        myTd.innerHTML = eachObj[a]
        myTr.appendChild(myTd)
       }
       var editTd = document.createElement("td");
       var editBtn = document.createElement("button");
       editBtn.innerHTML = "Edit"
       editBtn.setAttribute("onclick","editUser("+index+")")
       editTd.appendChild(editBtn)
       myTr.appendChild(editTd);

        document.querySelector("tbody").appendChild(myTr)
    }
}
getUsersFromAPI()

function editUser(i){
    console.log(i)
    localStorage.setItem("userToEdit",JSON.stringify(users[i]));
    window.location.href = "editUser.html"
}
    
    </script>
    
</body>
</html>