<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <form action="">
      <label for="">fname</label>
      <input type="text" id="fname" /> <br />
      <label for="">email</label>
      <input type="email" id="email" /><br />
      <label for="">state</label>
      <input type="text" id="state" /> <br />
      <label for="">dob</label>
      <input type="dob" id="dob" /> <br />

      <label for="">gender</label>
      <input type="radio" name="gender" value="male" >male
      <input type="radio" name="gender" value="female">female
      <input type="radio" name="gender" value="others">others <br><br>
      <label for="">subjects</label>
      <input type="checkbox" name="subjects" value="subject1" />subject1
      <input type="checkbox" name="subjects" value="subject2" />subject2
      <input type="checkbox" name="subjects" value="subject3" />subject3

      <button onclick="adduser()" type="button">adduser</button>
    </form>

    <table border="1">
      <thead>
        <tr>
          <th>fname</th>
          <th>email</th>
          <th>state</th>
          <th>dob</th>
          <th>subjects</th>
          <th>edit</th>
          <th>delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- create  -->
    <script>
      function adduser() {
        var user = {
          fname: document.getElementById("fname").value,
          email: document.getElementById("email").value,
          state: document.getElementById("state").value,
          dob: document.getElementById("dob").value,
          gender:"",
          subjects: [],
        };

        var allRadioBtns = document.getElementsByName("gender");
        for (i = 0; i < allRadioBtns.length; i++) {
          if (allRadioBtns[i].checked) {
            user.gender = allRadioBtns[i].value;
          }
        }

        var allcheckboxes = document.getElementsByName("subjects");
        for (let i = 0; i < allcheckboxes.length; i++) {
          if (allcheckboxes[i].checked) {
            user.subjects.push(allcheckboxes[i].value);
          }
        }

        console.log("adduser called", user);
        addusertoAPI(user);
      }
      function addusertoAPI(user) {
        var postdata = new XMLHttpRequest();
        postdata.onreadystatechange = function () {
          if (postdata.readyState === 4 && postdata.status==201){
           console.log('user added')
          }
        }
        postdata.open("POST", "http://localhost:3000/users");
        postdata.setRequestHeader("content-type", "application/JSON");
        postdata.send(JSON.stringify(user));
      }

      //read

      var users = [];
      function getusersfromAPI() {
        var getdata = new XMLHttpRequest();
        getdata.onreadystatechange = function () {
          if (getdata.readyState === 4 && getdata.status === 200) {
            console.log("user added", JSON.parse(getdata.response));
            users = JSON.parse(getdata.response)
            displayusers();
          }
        };
        getdata.open("GET", "http://localhost:3000/users");
        getdata.send();
      }
      getusersfromAPI();

      function displayusers() {
        //console.log(users)

        for (let i = 0; i < users.length; i++) {
          var mytr = document.createElement("tr");
          var eachobj = users[i];
          for (a in eachobj) {
            var mytd = document.createElement("td");
            mytd.innerHTML = eachobj[a];
            mytr.appendChild(mytd);
          }
          document.querySelector("tbody").appendChild(mytr)


         

          var edittd = document.createElement("td");
          var editbtn = document.createElement("button");
          editbtn.innerHTML = "edit";
          editbtn.setAttribute("onclick", "edituser(" + i + ")");
          edittd.appendChild(editbtn);
          mytr.appendChild(edittd);

          var deltd = document.createElement("td");
          var delbtn = document.createElement("button");
          delbtn.innerHTML = "delete";
          delbtn.setAttribute("onclick", "deleteuser(" + i + ")");
          deltd.appendChild(delbtn);
          mytr.appendChild(deltd);
        }
      }

      //edituser

      var gindex = null;
      function edituser(i) {
        // console.log(user[i])
        gindex = i;

        document.getElementById("fname").value = users[i].fname;
        document.getElementById("email").value = users[i].email;
        document.getElementById("dob").value = users[i].dob;
        document.getElementById("state").value = users[i].state;

        var allRadioBtns = document.getElementsByName("gender");
        for (index = 0; index < allRadioBtns.length; index++) {
          if (allRadioBtns[index].value == users[i].gender) {
            allRadioBtns[index].checked = true;
          }
        }

        var allcheckboxes = document.getElementsByName("subjects");
        for (index = 0; index < allcheckboxes.length; index++) {
          var check = users[i].subjects.some(
            (val) => allcheckboxes[index].value == val
          );
          allcheckboxes[index].checked = check;
        }
      }

      //update user

      function updateuser() {
        var user = {
          fname: document.getElementById("fname").value,
          email: document.getElementById("email").value,
          state: document.getElementById("state").value,
          dob: document.getElementById("dob").value,
          subjects: [],
        };

        var allRadioBtns = document.getElementsByName("gender");
        for(let index=0;index<allRadioBtns.length;index++){
          if(allRadioBtns[index].value==users[i].gender){
            allRadioBtns[index].checked==true
          }
        }

        var allcheckboxes=document.getElementsByName('subjects')
        for(let index=0;index<allcheckboxes.length;index++){
          var check=users[i].subjects.some((val)=>{
            allcheckboxes[index].value==val
          })
          allcheckboxes[index].checked=check
        }
      }

      function updateuser(){
        var user = {
          fname: document.getElementById("fname").value,
          lname: document.getElementById("lname").value,
          email: document.getElementById("email").value,
          state: document.getElementById("state").value,
          dob: document.getElementById("dob").value,
          gender: "",
          subjects: [],
        };
        
        var allRadioBtns = document.getElementsByName("gender");
        for (i = 0; i < allRadioBtns.length; i++) {
          if (allRadioBtns[i].checked) {
            user.gender = allRadioBtns[i].value;
          }
        }

        var allcheckboxes = document.getElementsByName("subjects");
        for (i = 0; i < allcheckboxes.length; i++) {
          if (allcheckboxes[i].checked) {
            user.subjects.push(allcheckboxes[i].value);
          }
        }
        updateUsertoAPI(user)
      }


      function updateUsertoAPI(user){

var postdata=new XMLHttpRequest();
postdata.onreadystatechange=function(){
  if(postdata.onreadystate ==4 && postdata.status==201){
    console.log("user added")
  }
}
postdata.open("PUT","http://localhost:3000/users" +users[gindex].id) 
postdata.setRequestHeader('content-type',"application/json")
postdata.send(JSON.stringify(user))

}

function deleteuser(){
var deletedata=new XMLHttpRequest();
deletedata.onreadystatechange=function(){
  if(deletedata.readyState==4 && deletedata.status==200){
    users=JSON.parse(deletedata.response)
    displayusers()
  }
}
deletedata.open("DELETE","http://localhost:3000/users" +users[i].id)
deletedata.send()
}

    </script>
  </body>
</html>
